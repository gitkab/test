<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éâ„É©„Ç§„Éñ„Éà„É©„ÉÉ„Ç´„Éº & „Éä„Éì</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Custom UI Overlay */
        .ui-overlay {
            position: absolute;
            z-index: 1000;
            pointer-events: none; /* Let clicks pass through to map where transparent */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .top-controls {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bottom-controls {
            pointer-events: auto;
            padding: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
            background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%);
            padding-bottom: 25px; /* iOS safe area */
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 14px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #3b82f6; }
        .btn-danger { background-color: #ef4444; }
        .btn-success { background-color: #22c55e; }
        .btn-warning { background-color: #f59e0b; }

        .search-box {
            display: flex;
            gap: 5px;
        }
        .search-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Leaflet Routing Machine customization to look better on mobile */
        .leaflet-routing-container {
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Hidden by default, toggled via JS */
        }
        .leaflet-routing-container.active {
            display: block;
        }

        .info-pill {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            text-align: center;
        }

        /* Custom pulsing marker for current location */
        .gps-ring {
            border: 3px solid #22c55e;
            -webkit-border-radius: 30px;
            height: 18px;
            width: 18px;
            -webkit-animation: pulsate 1s ease-out;
            -webkit-animation-iteration-count: infinite; 
            opacity: 0.0;
            border-radius: 30px;
            position: absolute;
            top: -2px;
            left: -2px;
        }
        .gps-circle {
            background-color: #22c55e;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }
        @-webkit-keyframes pulsate {
            0% {-webkit-transform: scale(0.1, 0.1); opacity: 0.0;}
            50% {opacity: 1.0;}
            100% {-webkit-transform: scale(1.2, 1.2); opacity: 0.0;}
        }
    </style>
</head>
<body>

    <div class="ui-overlay">
        <!-- Top Panel: Search & Status -->
        <div class="top-controls">
            <div class="flex justify-between items-center">
                <h1 class="text-lg font-bold text-gray-800">üöó „Éâ„É©„Ç§„Éñ„É≠„Ç∞</h1>
                <div id="statusbox" class="info-pill">ÂæÖÊ©ü‰∏≠</div>
            </div>
            
            <div class="search-box">
                <input type="text" id="destinationInput" class="search-input" placeholder="ÁõÆÁöÑÂú∞„ÇíÊ§úÁ¥¢ (‰æã: Êù±‰∫¨„Çø„ÉØ„Éº)">
                <button onclick="searchDestination()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Ê§úÁ¥¢</button>
            </div>
            <div class="text-xs text-gray-500 mt-1">‚ÄªÂú∞Âõ≥„ÇíÈï∑Êäº„Åó„Çø„ÉÉ„Éó„Åó„Å¶„ÇÇÁõÆÁöÑÂú∞Ë®≠ÂÆöÂèØËÉΩ</div>
        </div>

        <!-- Bottom Panel: Actions -->
        <div class="bottom-controls">
            <button id="toggleTrackBtn" class="btn btn-primary" onclick="toggleTracking()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm0 1A5 5 0 1 0 8 3a5 5 0 0 0 0 10z"/>
                    <path d="M10.015 7a.5.5 0 1 1 .97 0 .5.5 0 0 1-.97 0z"/>
                </svg>
                Ë®òÈå≤ÈñãÂßã
            </button>
            <button class="btn btn-warning" onclick="centerMap()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                </svg>
                ÁèæÂú®Âú∞
            </button>
            <button class="btn btn-danger" onclick="clearHistory()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                ÂâäÈô§
            </button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- Global Variables ---
        let map;
        let userMarker;
        let tracePolyline;
        let routeControl = null;
        let watchId = null;
        let isTracking = false;
        let pathHistory = [];
        let wakeLock = null;

        // --- Initialization ---
        function initMap() {
            // Default center (Tokyo) until GPS kicks in
            map = L.map('map').setView([35.6895, 139.6917], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Setup Custom Icon for User
            const gpsIcon = L.divIcon({
                className: 'css-icon',
                html: '<div class="gps-ring"></div><div class="gps-circle"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });

            // Initialize user marker (hidden initially)
            userMarker = L.marker([0, 0], {icon: gpsIcon}).addTo(map);

            // Initialize trace line
            tracePolyline = L.polyline([], {color: 'red', weight: 4, opacity: 0.7}).addTo(map);

            // Load saved history
            loadHistory();

            // Long press / Click handler for destination
            map.on('click', function(e) {
                setDestination(e.latlng);
            });

            // Start passive geolocation (just to find current spot, not recording yet)
            // Delay slightly to ensure permissions are checked
            setTimeout(() => updateLocation(false), 1000);
        }

        // --- Geolocation & Tracking Logic ---
        
        function updateLocation(center = false) {
            if (!navigator.geolocation) {
                alert("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            const success = (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const newLatLng = [lat, lng];

                userMarker.setLatLng(newLatLng);
                if(center) map.setView(newLatLng, 16);
                
                // Update status if needed
                const statusBox = document.getElementById('statusbox');
                if(statusBox.textContent === "GPS‰ø°Âè∑„É≠„Çπ„Éà") {
                   statusBox.textContent = isTracking ? "Ë®òÈå≤‰∏≠..." : "ÂæÖÊ©ü‰∏≠";
                   statusBox.style.background = isTracking ? "#22c55e" : "rgba(0,0,0,0.7)";
                }
            };

            const error = (err) => {
                console.warn(`GPS Error (${err.code}): ${err.message}`);
                
                // If High Accuracy fails, try low accuracy
                if (options.enableHighAccuracy) {
                    console.log("Retrying with low accuracy...");
                    navigator.geolocation.getCurrentPosition(
                        success, 
                        (err2) => {
                            handleGeoError(err2);
                        }, 
                        { enableHighAccuracy: false, timeout: 20000, maximumAge: 0 }
                    );
                } else {
                    handleGeoError(err);
                }
            };

            navigator.geolocation.getCurrentPosition(success, error, options);
        }
        
        function handleGeoError(err) {
            let msg = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";
            if (err.code === 1) msg += " (Ë®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü)";
            else if (err.code === 2) msg += " (‰ΩçÁΩÆÁâπÂÆö‰∏çÂèØ - ÈõªÊ≥¢Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ)";
            else if (err.code === 3) msg += " („Çø„Ç§„É†„Ç¢„Ç¶„Éà - ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ)";
            
            console.error(msg, err);
            // Don't alert on initial load to avoid annoyance, only log
        }

        function toggleTracking() {
            const btn = document.getElementById('toggleTrackBtn');
            const statusBox = document.getElementById('statusbox');

            if (isTracking) {
                // Stop Tracking
                if (watchId) navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm0 1A5 5 0 1 0 8 3a5 5 0 0 0 0 10z"/>
                        <path d="M10.015 7a.5.5 0 1 1 .97 0 .5.5 0 0 1-.97 0z"/>
                    </svg> Ë®òÈå≤ÈñãÂßã`;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
                statusBox.textContent = "‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠";
                statusBox.style.background = "rgba(0,0,0,0.7)";
                releaseWakeLock();
            } else {
                // Start Tracking
                if (!navigator.geolocation) return alert("GPS„Åå‰Ωø„Åà„Åæ„Åõ„Çì");
                
                requestWakeLock(); // Keep screen on

                // Use slightly more lenient options for watch
                const watchOptions = {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 20000 // Increased timeout
                };

                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        const latlng = [lat, lng];
                        
                        // Update UI
                        userMarker.setLatLng(latlng);
                        
                        // Add to path
                        pathHistory.push(latlng);
                        tracePolyline.setLatLngs(pathHistory);
                        
                        // Save to localStorage
                        saveHistory();
                        
                        // Reset status if it was in error state
                        if(statusBox.textContent.includes("„É≠„Çπ„Éà")) {
                            statusBox.textContent = "Ë®òÈå≤‰∏≠...";
                            statusBox.style.background = "#22c55e";
                        }
                    },
                    (err) => {
                        console.warn('Watch GPS Error: ' + err.message);
                        // If it's a timeout, we just wait for next signal, don't stop everything
                        if (err.code !== 3) {
                             statusBox.textContent = "GPS‰ø°Âè∑„É≠„Çπ„Éà";
                             statusBox.style.background = "orange";
                        }
                    },
                    watchOptions
                );

                isTracking = true;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                    </svg> ÂÅúÊ≠¢`;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                statusBox.textContent = "Ë®òÈå≤‰∏≠...";
                statusBox.style.background = "#22c55e";
                
                // Jump to current location immediately with retry logic
                updateLocation(true);
            }
        }

        function centerMap() {
            updateLocation(true);
        }

        // --- Storage Logic ---
        function saveHistory() {
            localStorage.setItem('drive_trace_jp', JSON.stringify(pathHistory));
        }

        function loadHistory() {
            const saved = localStorage.getItem('drive_trace_jp');
            if (saved) {
                try {
                    pathHistory = JSON.parse(saved);
                    tracePolyline.setLatLngs(pathHistory);
                    if (pathHistory.length > 0) {
                        map.fitBounds(tracePolyline.getBounds());
                    }
                } catch (e) {
                    console.error("Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº", e);
                }
            }
        }

        function clearHistory() {
            if (confirm("Ë®òÈå≤„Åï„Çå„ÅüÁßªÂãïÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                pathHistory = [];
                tracePolyline.setLatLngs([]);
                localStorage.removeItem('drive_trace_jp');
                
                // If routing is active, clear it too
                if (routeControl) {
                    map.removeControl(routeControl);
                    routeControl = null;
                }
                document.getElementById('destinationInput').value = "";
                alert("Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        }

        // --- Routing / Navigation Logic ---
        
        async function searchDestination() {
            const query = document.getElementById('destinationInput').value;
            if (!query) return;

            const statusBox = document.getElementById('statusbox');
            statusBox.textContent = "Ê§úÁ¥¢‰∏≠...";

            // Use Nominatim (OSM Geocoding)
            // Limit to Japan for better relevance
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=jp&limit=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const destLat = data[0].lat;
                    const destLon = data[0].lon;
                    const destLatLng = L.latLng(destLat, destLon);
                    
                    setDestination(destLatLng);
                    statusBox.textContent = "ÂæÖÊ©ü‰∏≠";
                } else {
                    alert("Â†¥ÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ‰ΩèÊâÄ„ÇÑÊúâÂêç„Å™Âª∫Áâ©Âêç„ÅßË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    statusBox.textContent = "‰∏çÊòé";
                }
            } catch (e) {
                console.error(e);
                alert("Ê§úÁ¥¢„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                statusBox.textContent = "„Ç®„É©„Éº";
            }
        }

        function setDestination(destLatLng) {
            // Check if we know where the user is
            if (!userMarker.getLatLng() || (userMarker.getLatLng().lat === 0 && userMarker.getLatLng().lng === 0)) {
                // Try to get location first
                updateLocation(false);
                setTimeout(() => {
                     // Check again after attempt
                     const currentLoc = userMarker.getLatLng();
                     if (currentLoc && currentLoc.lat !== 0) {
                         calculateRoute(currentLoc, destLatLng);
                     } else {
                         alert("ÁèæÂú®Âú∞„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„É´„Éº„ÉàÊ°àÂÜÖ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„ÄÇGPS„Çí„Ç™„É≥„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                     }
                }, 1500);
            } else {
                calculateRoute(userMarker.getLatLng(), destLatLng);
            }
        }

        function calculateRoute(start, end) {
            if (routeControl) {
                map.removeControl(routeControl);
            }

            routeControl = L.Routing.control({
                waypoints: [
                    start,
                    end
                ],
                routeWhileDragging: false,
                language: 'ja', // Japanese instructions
                showAlternatives: true,
                fitSelectedRoutes: true,
                createMarker: function(i, wp, nWps) {
                    // Customize start/end markers if needed, using defaults for simplicity now
                    if (i === 0) return null; // Hide start marker (we have our user marker)
                    return L.marker(wp.latLng, {
                        draggable: true
                    });
                },
                lineOptions: {
                    styles: [{color: 'blue', opacity: 0.6, weight: 6}]
                }
            }).addTo(map);
        }

        // --- Wake Lock (Prevent Screen Sleep) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release()
                    .then(() => {
                        wakeLock = null;
                        console.log('Wake Lock released');
                    });
            }
        }

        // Re-acquire wake lock if visibility changes (e.g. switching tabs)
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        // Start
        window.onload = initMap;

    </script>
</body>
</html>
